; -*- mode: emacs-lisp; lexical-binding: t -*-

;; Eldev configuration for beads.el

(eldev-use-package-archive 'gnu)
(eldev-use-package-archive 'melpa)

;; Enable undercover.el for code coverage tracking
(eldev-use-plugin 'undercover)

;; Configure undercover to track coverage for all lisp/*.el files except tests
;; This excludes lisp/test/* files from coverage instrumentation
(setf eldev-undercover-fileset '("lisp/*.el" ":not" "lisp/test/*.el"))

;; Use codecov format and don't auto-send
(setf eldev-undercover-config '(codecov dontsend))

;; IMPORTANT: Fix transient edebug specs for undercover instrumentation.
;;
;; Undercover uses edebug to instrument code for coverage. Edebug needs
;; proper specs for macros like `transient-define-prefix` to parse them.
;;
;; PROBLEM: Transient's edebug spec for transient-define-prefix uses
;; `[&rest vectorp]` which only allows vectors. But beads.el uses
;; `transient-define-group` to define reusable groups and includes them
;; by symbol reference (e.g., `beads-option-global-section`). This causes
;; "Failed matching" errors when undercover/edebug tries to instrument files.
;;
;; SOLUTION: Override the edebug specs to accept both vectors and symbols
;; using `[&rest [&or symbolp vectorp]]`.
;;
;; NOTE: This only affects source mode (`-s`) used by Coverage workflow.
;; In packaged mode, we just load transient (which Eldev already activates).
;; In source mode, we need package-activate-all to ensure newer ELPA transient.
(add-hook 'eldev-test-hook
          (lambda ()
            ;; In source mode, force package activation to get ELPA transient
            ;; (not the older built-in version in Emacs 29+/30+).
            ;; In packaged mode, Eldev already handles package activation.
            (when (eq eldev-project-loading-mode 'source)
              (package-activate-all))
            ;; Ensure transient is loaded before overriding its specs
            (require 'transient)
            ;; Override edebug specs to allow symbol references for groups
            ;; This is needed for coverage instrumentation in source mode
            ;; but is harmless in packaged mode (where edebug isn't used)
            (def-edebug-spec transient-define-prefix
              (&define name lambda-list
                       [&optional lambda-doc]
                       [&rest keywordp sexp]
                       [&rest [&or symbolp vectorp]]
                       [&optional ("interactive" interactive) def-body]))
            (def-edebug-spec transient-define-group
              (&define name [&rest [&or symbolp vectorp]]))))

(setq eldev-project-main-file "lisp/beads.el")

;; Ensure we upgrade built-in packages (like transient) with newer versions from archives
;; This is critical for Emacs 29+ where transient is built-in but may be outdated
;; The package dependencies are defined in lisp/beads.el Package-Requires header
;; Note: This variable was added in Emacs 29.1, so we check if it exists first
(when (boundp 'package-install-upgrade-built-in)
  (setq package-install-upgrade-built-in t))

;; Runtime dependencies (for older Emacs versions without built-in transient)
(eldev-add-extra-dependencies 'runtime '(transient))

;; Development dependencies
(eldev-add-extra-dependencies 'test '(ert))
(eldev-add-extra-dependencies 'lint '(package-lint))

;; Exclude worktree, share, and reference directories from everything
(setf eldev-standard-excludes
      `(:or ,eldev-standard-excludes "worktree/**" "share/**"
            "transient-reference/**" "beads-reference/**"))

;; Test files location
(setf eldev-test-fileset '("lisp/test/*.el"))

;; Load path includes lisp directory
(eldev-add-loading-roots 'build "lisp")
(eldev-add-loading-roots 'test "lisp")
(eldev-add-loading-roots 'test "lisp/test")
