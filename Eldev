; -*- mode: emacs-lisp; lexical-binding: t -*-

;; Eldev configuration for beads.el

(eldev-use-package-archive 'gnu)
(eldev-use-package-archive 'melpa)

;; =============================================================================
;; CRITICAL: Force newer transient from GNU ELPA over the built-in version
;; =============================================================================
;;
;; Emacs 29+ and 30+ have a BUILT-IN transient at an older version (~0.3.x)
;; that doesn't have `transient-define-group` (added in v0.9.0).
;;
;; The problem:
;; 1. When `(require 'transient)` runs, it finds the built-in version first
;; 2. The built-in provides the 'transient feature
;; 3. Once a feature is provided, require doesn't reload it
;; 4. Our code uses transient-define-group which doesn't exist in the built-in
;;
;; The solution:
;; Force the newer GNU ELPA transient to be loaded BEFORE any of our code
;; is compiled or loaded. We do this at TOP LEVEL (not in hooks) because
;; hooks run too late - by the time "Activating project package" happens,
;; byte-compilation has already failed.
;;
;; This must happen AFTER eldev-use-package-archive but BEFORE any code
;; that might load transient.
;; =============================================================================

;; Ensure package-install-upgrade-built-in is set before any package operations
(setq package-install-upgrade-built-in t)

;; Force unload built-in transient if it's loaded, so we can load the newer one
(when (featurep 'transient)
  (unload-feature 'transient t))

;; Initialize package system and activate all installed packages
;; This ensures the GNU ELPA transient (0.11.0) is active, not the built-in
(require 'package)
(package-initialize)
(package-activate-all)

;; Now load transient - this should get the newer version
(require 'transient nil t)

;; Enable undercover.el for code coverage tracking
(eldev-use-plugin 'undercover)

;; Configure undercover to track coverage for all lisp/*.el files except tests
;; This excludes lisp/test/* files from coverage instrumentation
(setf eldev-undercover-fileset '("lisp/*.el" ":not" "lisp/test/*.el"))

;; Use codecov format and don't auto-send
(setf eldev-undercover-config '(codecov dontsend))

;; IMPORTANT: Fix transient edebug specs BEFORE undercover instruments files.
;;
;; Undercover uses edebug to instrument code for coverage. Edebug needs
;; proper specs for macros like `transient-define-prefix` to parse them.
;;
;; PROBLEM: Transient's edebug spec for transient-define-prefix uses
;; `[&rest vectorp]` which only allows vectors. But transient supports
;; including pre-defined groups by symbol reference (via transient-define-group).
;; This causes "Failed matching" errors when edebug tries to parse prefixes
;; that use symbol references like `beads-option-global-section`.
;;
;; SOLUTION: Override the edebug specs to accept both vectors and symbols
;; using `[&rest [&or symbolp vectorp]]`. This must happen:
;; 1. After transient is loaded (so we can override its specs)
;; 2. Before undercover sets up its file handlers
;;
;; By adding this hook without APPEND, it runs before undercover's hook.
(add-hook 'eldev-test-hook
          (lambda ()
            ;; Force package activation to ensure transient is available
            (package-activate-all)
            ;; Ensure transient is loaded
            (require 'transient)
            ;; Override edebug specs to allow symbol references for groups
            ;; The original spec uses [&rest vectorp] but we need to allow
            ;; symbols for groups defined with transient-define-group
            (def-edebug-spec transient-define-prefix
              (&define name lambda-list
                       [&optional lambda-doc]
                       [&rest keywordp sexp]
                       [&rest [&or symbolp vectorp]]
                       [&optional ("interactive" interactive) def-body]))
            (def-edebug-spec transient-define-group
              (&define name [&rest [&or symbolp vectorp]]))))

(setq eldev-project-main-file "lisp/beads.el")

;; Runtime dependencies (for older Emacs versions without built-in transient)
(eldev-add-extra-dependencies 'runtime '(transient))
;; Also add transient as a build dependency to ensure it's available during byte-compilation
(eldev-add-extra-dependencies 'build '(transient))

;; Development dependencies
(eldev-add-extra-dependencies 'test '(ert))
(eldev-add-extra-dependencies 'lint '(package-lint))

;; IMPORTANT: Ensure transient is ACTIVATED before byte-compilation.
;; In packaged mode (-p), eldev byte-compiles the package before running tests.
;; During byte-compilation, transient-define-group must be available as a macro.
;;
;; The build-system-hook runs before compilation, so we force transient
;; activation here. We use package-activate-all to ensure the newer
;; installed version is used instead of the built-in.
(add-hook 'eldev-build-system-hook
          (lambda ()
            ;; Force all packages to activate (prefers newer installed over built-in)
            (package-activate-all)
            ;; Load project dependencies
            (eldev-load-project-dependencies 'build nil t)
            ;; Explicitly require transient to ensure it's loaded
            (require 'transient)
            ;; Verify we have the right version
            (unless (fboundp 'transient-define-group)
              (error "transient-define-group not found! Need transient >= 0.9.0"))))

;; Exclude worktree, share, and reference directories from everything
(setf eldev-standard-excludes
      `(:or ,eldev-standard-excludes "worktree/**" "share/**"
            "transient-reference/**" "beads-reference/**"))

;; Test files location
(setf eldev-test-fileset '("lisp/test/*.el"))

;; Load path includes lisp directory
(eldev-add-loading-roots 'build "lisp")
(eldev-add-loading-roots 'test "lisp")
(eldev-add-loading-roots 'test "lisp/test")
