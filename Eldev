; -*- mode: emacs-lisp; lexical-binding: t -*-

;; Eldev configuration for beads.el

(eldev-use-package-archive 'gnu)
(eldev-use-package-archive 'nongnu)
(eldev-use-package-archive 'melpa)

;; Enable undercover.el for code coverage tracking
(eldev-use-plugin 'undercover)

;; Configure undercover to track coverage for all lisp/*.el files except tests
;; This excludes lisp/test/* files from coverage instrumentation
(setf eldev-undercover-fileset '("lisp/*.el" ":not" "lisp/test/*.el"))

;; Use codecov format and don't auto-send
(setf eldev-undercover-config '(codecov dontsend))

;; IMPORTANT: Fix transient edebug specs for undercover instrumentation.
;;
;; Undercover uses edebug to instrument code for coverage. Edebug needs
;; proper specs for macros like `transient-define-prefix` to parse them.
;;
;; PROBLEM: Transient's edebug spec for transient-define-prefix uses
;; `[&rest vectorp]` which only allows vectors. But beads.el uses
;; `transient-define-group` to define reusable groups and includes them
;; by symbol reference (e.g., `beads-option-global-section`). This causes
;; "Failed matching" errors when undercover/edebug tries to instrument files.
;;
;; SOLUTION: Override the edebug specs to accept both vectors and symbols
;; using `[&rest [&or symbolp vectorp]]`.
;;
;; NOTE: This only affects source mode (`-s`) used by Coverage workflow.
;; Packaged mode (`-p`) used by Test workflow doesn't use edebug.

;; Define the edebug spec fix function
(defun beads--fix-transient-edebug-specs ()
  "Override transient edebug specs to allow symbol references for groups.
This is required for undercover coverage instrumentation to work with
transient-define-prefix forms that include symbols defined by
transient-define-group."
  (def-edebug-spec transient-define-prefix
    (&define name lambda-list
             [&optional lambda-doc]
             [&rest keywordp sexp]
             [&rest [&or symbolp vectorp]]
             [&optional ("interactive" interactive) def-body]))
  (def-edebug-spec transient-define-group
    (&define name [&rest [&or symbolp vectorp]])))

;; Use eval-after-load to ensure our specs are set whenever transient loads.
;; This handles the case where transient is loaded/reloaded after our hook runs.
(eval-after-load 'transient
  '(when (eq eldev-project-loading-mode 'source)
     (beads--fix-transient-edebug-specs)))

;; Ensure transient is properly loaded before undercover instrumentation.
;;
;; CRITICAL: The eldev-test-hook runs BEFORE dependencies are installed,
;; so we cannot load transient there. Instead, we use eval-after-load
;; which triggers when transient is actually loaded (after installation).
;;
;; The eval-after-load above handles setting edebug specs, but we also
;; need to ensure transient-define-group is available as a function
;; (not just as an edebug spec) when undercover instruments files.
;;
;; Hook into eldev's dependency loading to ensure transient is required
;; after it's installed but before files are instrumented.
(advice-add 'eldev-load-extra-dependencies :after
            (lambda (&rest _)
              (when (eq eldev-project-loading-mode 'source)
                ;; Now transient should be installed, require it
                (require 'transient nil t)
                ;; Apply edebug spec fix
                (beads--fix-transient-edebug-specs))))

(setq eldev-project-main-file "lisp/beads.el")

;; Fix EMACS_TEST_JUNIT_REPORT to write to the specified path.
;;
;; ERT's ert-write-junit-test-report ignores the EMACS_TEST_JUNIT_REPORT value
;; when determining the output filename - it uses ert-load-file-name instead.
;; This advice fixes that by writing to the env var path when set.
(defun beads--fix-junit-report-path (orig-fn stats)
  "Advice to write JUnit report to EMACS_TEST_JUNIT_REPORT path.
ORIG-FN is the original function, STATS is the test statistics."
  (if-let ((report-path (getenv "EMACS_TEST_JUNIT_REPORT")))
      ;; Write to the specified path instead of the default location
      (let ((ert-load-file-name report-path))
        (funcall orig-fn stats)
        ;; The file was written with .xml extension, rename if needed
        (let ((xml-path (file-name-with-extension report-path "xml")))
          (unless (string= xml-path report-path)
            (when (file-exists-p xml-path)
              (rename-file xml-path report-path t)))))
    ;; No env var set, use default behavior
    (funcall orig-fn stats)))

;; Apply the advice when ERT is loaded
(eval-after-load 'ert
  '(advice-add 'ert-write-junit-test-report :around #'beads--fix-junit-report-path))

;; Runtime dependencies using extended dependency format with explicit versions.
;; transient 0.10.1 is required for transient-define-group and other features.
;; Allow both GNU and NonGNU ELPA since transient 0.11.0 requires cond-let
;; which is only available in NonGNU ELPA.
(eldev-add-extra-dependencies 'runtime
                              '(:package transient :version "0.10.1"))
(eldev-add-extra-dependencies 'runtime
                              '(:package sesman :version "0.3.2"))

;; Development dependencies using extended dependency format
(eldev-add-extra-dependencies 'test
                              '(:package ert))
(eldev-add-extra-dependencies 'lint
                              '(:package package-lint :archive melpa))

;; Exclude worktree, share, and reference directories from everything
;; Note: bde-* directories are git worktrees created by beads-agent
;; Note: eca-support is a separate worktree for development
(setf eldev-standard-excludes
      `(:or ,eldev-standard-excludes "worktree/**" "share/**"
            "transient-reference/**" "beads-reference/**" "efrit-reference/**"
            "bde-*/**" "eca-support/**"))

;; Test files location
(setf eldev-test-fileset '("lisp/test/*.el"))

;; Load path includes lisp directory
(eldev-add-loading-roots 'build "lisp")
(eldev-add-loading-roots 'test "lisp")
(eldev-add-loading-roots 'test "lisp/test")
